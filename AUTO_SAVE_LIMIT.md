# 🎯 自动保存数量限制功能

## ✨ 功能概述

为了防止自动保存的会话无限增长，现在可以配置**每个项目保留的自动保存数量**。

---

## 🔧 功能特性

### 核心功能

- ✅ **可配置数量**：支持 3/5/10/20/50 个选项
- ✅ **默认保留 3 个**：适合大多数使用场景
- ✅ **智能清理**：自动删除超出数量的旧会话
- ✅ **只清理自动保存**：手动保存不受影响
- ✅ **持久化设置**：保存到浏览器 localStorage

### 工作原理

```
每次自动保存时：
  ↓
1. 保存新会话
  ↓
2. 获取当前项目所有自动保存
  ↓
3. 按时间倒序排列
  ↓
4. 保留最新的 N 个
  ↓
5. 删除超出数量的旧会话
  ↓
完成（空间节省 + 列表清爽）
```

---

## 📊 配置选项

| 保留数量 | 适用场景 | 存储空间 | 推荐度 |
|---------|---------|---------|--------|
| **3 个** | 日常开发 | 最小 | ⭐⭐⭐⭐⭐ |
| **5 个** | 中等项目 | 较小 | ⭐⭐⭐⭐ |
| **10 个** | 重要项目 | 中等 | ⭐⭐⭐ |
| **20 个** | 长期项目 | 较大 | ⭐⭐ |
| **50 个** | 归档需求 | 最大 | ⭐ |

### 推荐配置

```
默认（3个）：
  ├─ 适合大多数开发场景
  ├─ 保留最近 3 个自动保存
  ├─ 空间占用最小
  └─ 列表简洁清爽

中等（5-10个）：
  ├─ 需要更多历史记录
  ├─ 重要项目或实验性开发
  └─ 空间占用适中

大量（20-50个）：
  ├─ 长期项目
  ├─ 需要追溯较久的历史
  └─ 有充足存储空间
```

---

## 🎨 界面展示

### 配置位置

```
状态栏：
  [✓] 🤖 自动保存 (每1分钟)
      ↓
  [间隔选择] 每1分钟 ▼
      ↓
  [数量限制] 保留最近 [3个 ▼] 自动保存  ← 新功能！
```

### 操作步骤

```
1. 开启自动保存
   ↓
2. 选择保存间隔
   ↓
3. 选择保留数量（默认 3 个）
   ↓
4. 开始自动工作
```

---

## 💡 使用示例

### 场景 1：日常开发（推荐）

```
配置：
  间隔：每 1 分钟
  保留：3 个

效果：
  时间轴：
  14:30 - 自动保存 ✓
  14:31 - 自动保存 ✓
  14:32 - 自动保存 ✓
  14:33 - 自动保存 ✓  （14:30 被删除）
  14:34 - 自动保存 ✓  （14:31 被删除）
  
  结果：始终保持最新 3 个
```

### 场景 2：实验性开发

```
配置：
  间隔：每 30 秒
  保留：5 个

效果：
  更频繁的保存
  +
  保留更多历史
  =
  可以回溯到 2.5 分钟前
```

### 场景 3：重要项目

```
配置：
  间隔：每 2 分钟
  保留：10 个

效果：
  适中的保存频率
  +
  较多的历史记录
  =
  可以回溯到 20 分钟前
```

---

## 🔍 实际运行演示

### 保留 3 个的完整过程

```
初始状态：
  （无自动保存）

14:30:00 - 自动保存触发
  ✓ DeepSeek OCR WebUI - 10月25日 14:30
  总计：1 个

14:31:00 - 自动保存触发
  ✓ DeepSeek OCR WebUI - 10月25日 14:31
  ✓ DeepSeek OCR WebUI - 10月25日 14:30
  总计：2 个

14:32:00 - 自动保存触发
  ✓ DeepSeek OCR WebUI - 10月25日 14:32
  ✓ DeepSeek OCR WebUI - 10月25日 14:31
  ✓ DeepSeek OCR WebUI - 10月25日 14:30
  总计：3 个（达到上限）

14:33:00 - 自动保存触发
  ✓ DeepSeek OCR WebUI - 10月25日 14:33 ← 新保存
  ✓ DeepSeek OCR WebUI - 10月25日 14:32
  ✓ DeepSeek OCR WebUI - 10月25日 14:31
  ✗ DeepSeek OCR WebUI - 10月25日 14:30 ← 被删除
  总计：3 个（保持上限）

14:34:00 - 自动保存触发
  ✓ DeepSeek OCR WebUI - 10月25日 14:34 ← 新保存
  ✓ DeepSeek OCR WebUI - 10月25日 14:33
  ✓ DeepSeek OCR WebUI - 10月25日 14:32
  ✗ DeepSeek OCR WebUI - 10月25日 14:31 ← 被删除
  总计：3 个（保持上限）
```

**结果**：无论运行多久，自动保存始终保持在 3 个。

---

## 🛡️ 安全保护

### 手动保存不受影响

```
会话列表：
  ✓ DeepSeek OCR WebUI - 10月25日 14:35 [自动]
  ✓ DeepSeek OCR WebUI - 10月25日 14:34 [自动]
  ✓ DeepSeek OCR WebUI - 10月25日 14:33 [自动]
  ✓ 完成UI颜色修复 [手动] ⭐  ← 永不删除
  ✓ 实现自动保存功能 [手动] ⭐  ← 永不删除
  ✓ 添加用户认证 [手动] ⭐  ← 永不删除

清理规则：
  ├─ 只删除标记为 auto_saved: true 的会话
  ├─ 手动保存 (auto_saved: false) 永久保留
  └─ 保护重要里程碑
```

### 多项目独立管理

```
项目 A：保留最近 3 个
  ├─ A - 10月25日 14:35
  ├─ A - 10月25日 14:34
  └─ A - 10月25日 14:33

项目 B：保留最近 3 个
  ├─ B - 10月25日 15:20
  ├─ B - 10月25日 15:19
  └─ B - 10月25日 15:18

项目 C：保留最近 3 个
  ├─ C - 10月25日 16:45
  ├─ C - 10月25日 16:44
  └─ C - 10月25日 16:43

每个项目独立计数，互不影响！
```

---

## 📈 存储空间对比

### 单个会话大小

```
平均大小：3-5 MB（视对话长度而定）
```

### 不同配置的空间占用

| 配置 | 单项目 | 3个项目 | 10个项目 |
|------|--------|---------|----------|
| **3 个** | 9-15 MB | 27-45 MB | 90-150 MB |
| **5 个** | 15-25 MB | 45-75 MB | 150-250 MB |
| **10 个** | 30-50 MB | 90-150 MB | 300-500 MB |
| **20 个** | 60-100 MB | 180-300 MB | 600-1000 MB |
| **50 个** | 150-250 MB | 450-750 MB | 1.5-2.5 GB |

### 长期运行对比

```
无限制（24小时，每分钟保存）：
  24 × 60 = 1440 个会话
  1440 × 4 MB ≈ 5.6 GB （每个项目！）
  ❌ 不可持续

保留 3 个：
  始终 3 个会话
  3 × 4 MB = 12 MB （每个项目）
  ✅ 可持续
```

---

## 🎯 最佳实践

### 推荐配置组合

**方案 1：轻量级（推荐）**
```
间隔：每 1 分钟
保留：3 个
优势：
  ✅ 平衡的保存频率
  ✅ 最小的存储占用
  ✅ 足够的回溯能力（3 分钟）
```

**方案 2：标准型**
```
间隔：每 2 分钟
保留：5 个
优势：
  ✅ 适中的保存频率
  ✅ 合理的存储占用
  ✅ 较好的回溯能力（10 分钟）
```

**方案 3：专业型**
```
间隔：每 5 分钟
保留：10 个
优势：
  ✅ 低频率保存
  ✅ 更多历史记录
  ✅ 长时间回溯能力（50 分钟）
```

### 工作流建议

```
日常开发：
  ├─ 自动保存：3 个（每 1 分钟）
  ├─ 重要节点：手动保存并命名
  └─ 定期清理：保留重要的手动保存

实验开发：
  ├─ 自动保存：5 个（每 30 秒）
  ├─ 成功实验：手动保存记录
  └─ 失败实验：自动清理

生产项目：
  ├─ 自动保存：10 个（每 2 分钟）
  ├─ 版本发布：手动保存标记
  └─ 长期归档：导出重要会话
```

---

## 🔧 技术实现

### 后端逻辑

```python
@app.post("/api/sessions/auto-save")
async def auto_save_session(max_keep: int = 3):
    # 1. 保存新会话
    save_new_session()
    
    # 2. 清理旧会话
    cleanup_old_auto_saves(project_dir, max_keep)
    
def cleanup_old_auto_saves(project_dir, max_keep):
    # 只获取自动保存的会话
    auto_saves = [s for s in sessions if s.auto_saved]
    
    # 按时间倒序
    auto_saves.sort(by_time, reverse=True)
    
    # 保留最新的 max_keep 个
    keep = auto_saves[:max_keep]
    delete = auto_saves[max_keep:]
    
    # 删除旧会话
    for session in delete:
        delete_files(session)
```

### 前端实现

```javascript
// 配置
let autoSaveKeepCount = 3;

// 保存设置
localStorage.setItem('autoSaveKeepCount', autoSaveKeepCount);

// 自动保存时传递参数
fetch(`/api/sessions/auto-save?max_keep=${autoSaveKeepCount}`)
```

---

## 📊 功能总结

### 核心优势

- ✅ **防止无限增长**：自动控制会话数量
- ✅ **节省存储空间**：只保留最新的
- ✅ **保持列表清爽**：易于查找和管理
- ✅ **智能保护**：手动保存永不删除
- ✅ **灵活配置**：适应不同需求

### 适用场景

| 场景 | 推荐配置 | 原因 |
|------|---------|------|
| 个人开发 | 3 个 | 简单清爽 |
| 团队协作 | 5 个 | 需要更多历史 |
| 商业项目 | 10 个 | 重要记录保留 |
| 实验研究 | 5-10 个 | 频繁尝试 |
| 长期维护 | 10-20 个 | 长时间回溯 |

---

## 🎊 使用指南

### 第一次使用

1. **访问页面**
   ```
   http://44.193.212.118:8899
   ```

2. **开启自动保存**
   - 勾选"🤖 自动保存"
   - 选择间隔（推荐：每 1 分钟）

3. **配置保留数量**
   - 选择"保留最近 3 个自动保存"
   - 或根据需求选择其他数量

4. **开始工作**
   - 系统自动保存
   - 自动清理旧会话
   - 保持 3 个最新的

### 日常使用

```
✅ 无需手动清理
✅ 自动维护数量
✅ 专注于开发
✅ 需要时恢复
```

---

## 🌐 访问体验

**Web 界面**：http://44.193.212.118:8899

**GitHub 仓库**：https://github.com/neosun100/cursor-session-manager

**强制刷新**：`Ctrl + F5` 或 `Cmd + Shift + R`

---

## ✨ 更新日志

**v2.1.0** (2025-10-25)
- ✅ 添加自动保存数量限制
- ✅ 支持 3/5/10/20/50 个选项
- ✅ 智能清理超出数量的旧会话
- ✅ 手动保存不受影响
- ✅ 多项目独立管理

---

## 🎉 总结

现在您可以：

✅ **设置保留数量**：防止无限增长  
✅ **自动清理旧会话**：保持列表清爽  
✅ **节省存储空间**：只保留最新的  
✅ **保护手动保存**：重要会话永久保留  
✅ **灵活配置**：适应不同需求  

**立即体验**：http://44.193.212.118:8899 🚀

---

**版本**：v2.1.0  
**更新日期**：2025-10-25  
**状态**：✅ 已部署上线
